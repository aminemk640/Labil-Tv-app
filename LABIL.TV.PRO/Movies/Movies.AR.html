<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic Movies </title>
		<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#020617">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" type="image/png" href="logo.png">
<link rel="apple-touch-icon" href="logo.png">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-pink: #ed1b76;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --modal-bg: rgba(10, 15, 30, 0.98);
            --focus-glow: 0 0 15px 3px rgba(237, 27, 118, 0.6);
            --watched-color: #249f9c;
            --fhd-color: #ed1b76;
            --hd-color: #249f9c;
            --sd-color: #fbbf24;
        }

        body {
            margin: 0;
            font-family: 'Cairo', sans-serif;
            background: #020617;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        /* Header Layout */
        .sg-app-header {
            height: 70px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4%;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 2000;
            border-bottom: 2px solid var(--primary-pink);
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        /* Search Bar Mode */
        .header-search-active {
            justify-content: flex-start;
            gap: 10px;
        }

        #search-input-container {
            display: none;
            flex-grow: 1;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px 10px;
            border: 1px solid var(--glass-border);
        }

        #search-input {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            font-family: 'Cairo';
            font-size: 1rem;
            outline: none;
            padding: 5px 10px;
        }

        #search-input:focus {
            outline: none;
        }
        
        #search-input-container:focus-within {
             outline: 2px solid var(--primary-pink);
             outline-offset: 2px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sg-nav-icon {
            font-size: 1.1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.3s;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            color: white;
            border: none;
        }

        .sg-nav-icon:focus {
            background: var(--primary-pink);
            outline: none;
            box-shadow: var(--focus-glow);
            transform: scale(1.1);
        }

        .sg-nav-icon:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Section Title */
        .section-header {
            margin-top: 90px;
            padding: 10px 6%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-header button {
            background: none;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-family: 'Cairo';
            padding: 5px 10px;
            border-radius: 8px;
        }

        .section-header button:focus {
            outline: 2px solid var(--primary-pink);
            background: rgba(255,255,255,0.05);
        }

        .section-header h2 { margin: 0; font-size: 1.1rem; color: #cbd5e1; }

        /* Grid Layout */
        .sg-episodes-grid {
            padding: 10px 5% 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .sg-episodes-grid { 
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .sg-episodes-grid { 
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        /* Card Component */
        .sg-card-item {
            background: var(--glass-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            transition: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
        }

        .sg-card-item:focus, .sg-card-item:hover {
            outline: none;
            transform: scale(1.05);
            border-color: var(--primary-pink);
            box-shadow: var(--focus-glow);
            z-index: 10;
        }

        .sg-poster-box { 
            position: relative; 
            width: 100%; 
            padding-top: 145%;
            background: linear-gradient(45deg, #1e293b, #0f172a);
            overflow: hidden;
        }
        
        .sg-poster-box img { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            transition: opacity 0.5s ease;
        }
        
        .sg-poster-box img.loading { opacity: 0.3; }
        .sg-poster-box img.loaded { opacity: 1; }

        /* Watched Badge - Eye Icon */
        .sg-watched-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--watched-color);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1.5px solid rgba(255,255,255,0.3);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .sg-watched-badge i { 
            font-size: 0.8rem;
            color: white; 
        }

        .is-watched .sg-watched-badge { 
            opacity: 1; 
            transform: scale(1);
        }

        .is-watched .sg-poster-box::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 5;
        }

        .sg-card-meta { 
            padding: 8px 6px;
            background: #0f172a; 
            text-align: center; 
            border-top: 1px solid var(--glass-border);
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .sg-episode-label { 
            font-size: 0.85rem;
            font-weight: 700; 
            color: #fff;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 3px;
        }

        /* Movie Year */
        .movie-year {
            color: var(--primary-pink);
            font-weight: bold;
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* Empty State */
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px 20px;
        }
        .no-results i { 
            font-size: 3.5rem;
            color: var(--glass-border); 
            margin-bottom: 15px;
        }
        .no-results p { 
            font-size: 1.1rem;
            color: #94a3b8; 
        }
        
        .reset-search-btn {
            background: var(--primary-pink);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-family: 'Cairo';
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .reset-search-btn:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* Modal Styles */
        .sg-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sg-modal-overlay.active { 
            display: flex; 
            opacity: 1; 
        }

        .sg-server-panel {
            background: var(--modal-bg);
            padding: 25px;
            border-radius: 20px;
            border: 1.5px solid var(--primary-pink);
            box-shadow: 0 0 30px rgba(237, 27, 118, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .sg-modal-overlay.active .sg-server-panel { 
            transform: scale(1); 
        }

        .sg-server-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            width: 100%;
            color: white;
            font-family: 'Cairo';
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .sg-server-btn:hover { 
            background: rgba(255,255,255,0.1); 
        }

        .sg-server-btn:focus { 
            outline: none; 
            background: rgba(255,255,255,0.15); 
            border-color: var(--primary-pink); 
            transform: translateX(-5px);
            box-shadow: 0 0 15px rgba(237, 27, 118, 0.4);
        }

        .sg-quality { 
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: bold; 
            font-size: 0.8rem;
            color: #fff; 
            min-width: 45px;
            text-align: center;
        }
        .q-fhd { background: var(--fhd-color); }
        .q-hd { background: var(--hd-color); }
        .q-sd { background: var(--sd-color); color: #000; }

        .sg-close-btn { 
            width: 100%; 
            background: #334155; 
            color: #fff; 
            border: none; 
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            cursor: pointer; 
            font-family: 'Cairo'; 
            font-weight: bold;
            font-size: 0.95rem;
        }

        .sg-close-btn:focus, .sg-close-btn:hover {
            outline: 2px solid white;
            outline-offset: 2px;
            background: #475569;
        }

        /* تنبيه مثبت/غير مثبت */
        .sg-install-alert {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #22c55e;
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.4);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .sg-install-alert i { 
            font-size: 3.5rem; 
            color: #22c55e; 
            margin-bottom: 20px;
            display: block;
        }

        .sg-install-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Cairo';
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin: 15px 0 10px;
            text-decoration: none;
            display: block;
        }

        .sg-install-btn:hover {
            background: #16a34a;
        }

        /* Remote Control Hint */
        .remote-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            color: #cbd5e1;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }

        @media (min-width: 1024px) {
            .remote-hint { display: flex; }
        }
    </style>
</head>
<body>

    <header class="sg-app-header" id="main-header">
        <div class="header-actions" id="normal-header-left">
            <button class="sg-nav-icon" tabindex="1" onclick="window.history.back()" title="رجوع" aria-label="الرجوع للصفحة السابقة">
                <i class="fas fa-arrow-right"></i>
            </button>
            <button class="sg-nav-icon" tabindex="2" onclick="window.location.reload()" title="تحديث" aria-label="تحديث الصفحة">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <div id="header-title" style="font-weight: 700; color: var(--primary-pink); font-size: 1.3rem; text-shadow: 0 0 10px rgba(237, 27, 118, 0.5);">
            أفلام <span style="color:white; font-size: 0.9rem; opacity: 0.8;">عربية</span>
        </div>

        <div id="search-input-container"tabindex="2">
            <i class="fas fa-times close-search-icon" 
               onclick="toggleSearch(false)" 
               style="cursor: pointer; margin-left: 10px; padding: 8px; font-size: 1.1rem; color: var(--primary-pink);"
               tabindex="101"
               title="إغلاق البحث"
               aria-label="إغلاق البحث"></i>
               
            <input type="text" id="search-input" 
                   placeholder="ابحث عن اسم الفيلم أو السنة..." 
                   oninput="handleSearch(this.value)"
                   tabindex="102">
                   
            <i class="fas fa-eraser close-search-icon" 
               onclick="clearSearch()" 
               style="cursor: pointer; margin-right: 10px; padding: 4px; color: #94a3b8;"
               tabindex="103"
               title="مسح النص"
               aria-label="مسح البحث"></i>
        </div>

        <div class="header-actions" id="normal-header-right">
            <button class="sg-nav-icon search-icon" 
               tabindex="3" 
               onclick="toggleSearch(true)"
               title="بحث"
               aria-label="فتح البحث">
               <i class="fas fa-search"></i>
            </button>
        </div>
    </header>

    <!-- Remote Hint -->
    <div class="remote-hint">
        <i class="fas fa-film"></i>
        <span>استخدم الأسهم للتنقل بين الأفلام</span>
    </div>

    <div class="section-header">
        <div>
          <button onclick="confirmReset()" title="مسح سجل المشاهدة" tabindex="4">  
            <i class="fas fa-trash-alt" style="color: var(--primary-pink); font-size: 0.9rem;"></i>
            <h2 id="page-title" style="font-size: 1rem;">مسح سجل الأفلام</h2>
            <i class="fas fa-eye-slash" style="color: var(--primary-pink); font-size: 0.9rem;"></i>
          </button>
        </div>
    </div>

    <!-- Changed data-section to Movies section -->
    <main class="sg-episodes-grid" id="sg-grid-root" data-section="Arabic_Movies">
        <!-- Movies populated by JS -->
    </main>

    <!-- Server Selection Modal -->
    <div class="sg-modal-overlay" id="sg-main-modal">
        <div class="sg-server-panel">
            <h3 id="sg-modal-title" style="margin-bottom:20px; color: #fff; font-size: 1.2rem;">اختر جودة الفيلم</h3>
            <div id="sg-servers-container">
                <!-- Buttons injected here -->
            </div>
            <button class="sg-close-btn" tabindex="99" onclick="sgCloseMenu()">إلغاء</button>
        </div>
    </div>

    <!-- Modal جديد للتحميل -->
    <div class="sg-modal-overlay" id="sg-install-modal">
        <div class="sg-install-alert" id="install-alert-content">
            <!-- سيتم تعبئته ديناميكياً -->
        </div>
    </div>

    <script>
        // Data Configuration - MOVIES instead of episodes
        const movies = [
            { 
                id: "m1", 
                title: "روكي الغلابة", 
                year: "2025",
                poster: "https://a.asd.homes/wp-content/uploads/2025/10/660x990-367x550.webp",
                backupPoster: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='367' height='550' viewBox='0 0 367 550'%3E%3Crect width='367' height='550' fill='%231e293b'/%3E%3Ctext x='183.5' y='250' font-family='Cairo, sans-serif' font-size='20' fill='%23ed1b76' text-anchor='middle' font-weight='bold'%3Eأفلام عربية%3C/text%3E%3Ctext x='183.5' y='280' font-family='Cairo, sans-serif' font-size='16' fill='%23ffffff' text-anchor='middle'%3Eروكي الغلابة%3C/text%3E%3Ctext x='183.5' y='310' font-family='Cairo, sans-serif' font-size='14' fill='%23cbd5e1' text-anchor='middle'%3E2025%3C/text%3E%3C/svg%3E",
                links: [
                    { quality: "FHD", url: "intent://dl.dropbox.com/scl/fi/09tc4bu8ave4texo63u4o/Squid.Game.S03E01.mp4?rlkey=njkf85n7wi2mmvjr9z7shkm4l&dl=1#Intent;scheme=https;package=co.wuffy.player;end" },
                    { quality: "HD", url: "intent://dl.dropbox.com/scl/fi/09tc4bu8ave4texo63u4o/Squid.Game.S03E01.mp4?rlkey=njkf85n7wi2mmvjr9z7shkm4l&dl=1#Intent;scheme=https;package=co.wuffy.player;end" },
                    { quality: "SD", url: "intent://dl.dropbox.com/scl/fi/09tc4bu8ave4texo63u4o/Squid.Game.S03E01.mp4?rlkey=njkf85n7wi2mmvjr9z7shkm4l&dl=1#Intent;scheme=https;package=co.wuffy.player;end" }
                ] 
            },
            { 
                id: "m2", 
                title: "السادة الأفاضل", 
                year: "2025",
                poster: "https://a.asd.homes/wp-content/uploads/2026/01/8LjhxTjblaE17VQSbKwNNvhXYc-scaled-367x550.webp",
                backupPoster: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='367' height='550' viewBox='0 0 367 550'%3E%3Crect width='367' height='550' fill='%231e293b'/%3E%3Ctext x='183.5' y='250' font-family='Cairo, sans-serif' font-size='20' fill='%23ed1b76' text-anchor='middle' font-weight='bold'%3Eأفلام عربية%3C/text%3E%3Ctext x='183.5' y='280' font-family='Cairo, sans-serif' font-size='16' fill='%23ffffff' text-anchor='middle'%3Eالسادة الأفاضل%3C/text%3E%3Ctext x='183.5' y='310' font-family='Cairo, sans-serif' font-size='14' fill='%23cbd5e1' text-anchor='middle'%3E2025%3C/text%3E%3C/svg%3E",
                links: [
                    { quality: "FHD", url: "intent://dl.dropbox.com/scl/fi/xwyexmxoffftts6mz4nkg/Squid.Game.S03E02.mp4?rlkey=2sioutniwvqxwjbdlpe87br7b&dl=1#Intent;scheme=https;package=co.wuffy.player;end" },
                    { quality: "HD", url: "intent://dl.dropbox.com/scl/fi/xwyexmxoffftts6mz4nkg/Squid.Game.S03E02.mp4?rlkey=2sioutniwvqxwjbdlpe87br7b&dl=1#Intent;scheme=https;package=co.wuffy.player;end" }
                ]
            }
        ];

        let currentId = "";
        let currentUrl = "";
        let isSearchActive = false;
        const imageCache = new Map();
        let isAppChecking = false;
        let appCheckTimeout = null;
        let wasAppOpened = false; // متغير لتتبع إذا تم فتح التطبيق

        // Helper for Section-based History
        function getHistoryKey() {
            const section = document.getElementById('sg-grid-root').getAttribute('data-section');
            return section ? `history_${section}` : 'movies_history';
        }

        // دالة محسنة للتحقق من وجود التطبيق
        function checkWuffyPlayerInstalled(url) {
            if (isAppChecking) return;
            
            isAppChecking = true;
            currentUrl = url;
            wasAppOpened = false;
            
            // إذا كان جهاز iOS، لا يدعم intent
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            if (isIOS) {
                showInstallModal();
                isAppChecking = false;
                return;
            }

            // حفظ وقت البدء
            const startTime = Date.now();
            
            // 1. أولاً: محاولة فتح التطبيق مباشرة
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.style.visibility = 'hidden';
            iframe.style.position = 'absolute';
            iframe.style.top = '-1000px';
            iframe.style.left = '-1000px';
            
            // إضافة الـ iframe إلى الجسم
            document.body.appendChild(iframe);
            
            // تعيين src للـ iframe
            iframe.src = url;
            
            // 2. مراقبة حدث تحميل الصفحة لمعرفة إذا فتح التطبيق
            window.addEventListener('blur', onWindowBlur);
            window.addEventListener('focus', onWindowFocus);
            
            // 3. بعد 1.5 ثانية، تحقق إذا تم فتح التطبيق
            appCheckTimeout = setTimeout(() => {
                // إذا لم يتم فتح التطبيق بعد 1.5 ثانية
                if (!wasAppOpened) {
                    // إلغاء الـ listeners
                    window.removeEventListener('blur', onWindowBlur);
                    window.removeEventListener('focus', onWindowFocus);
                    
                    // إزالة الـ iframe
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                    
                    // عرض رسالة التثبيت
                    showInstallModal();
                    isAppChecking = false;
                }
            }, 1500);
            
            // 4. تابع فتح الرابط مباشرة أيضاً (للأمان)
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        // دالة عند خروج النافذة من التركيز (عند فتح التطبيق)
        function onWindowBlur() {
            wasAppOpened = true;
            clearTimeout(appCheckTimeout);
            
            // إزالة الـ listeners
            window.removeEventListener('blur', onWindowBlur);
            window.removeEventListener('focus', onWindowFocus);
            
            // وضع علامة كمشاهدة بعد تأخير بسيط
            setTimeout(() => {
                markAsWatched();
                isAppChecking = false;
            }, 1000);
        }

        // دالة عند عودة التركيز للنافذة
        function onWindowFocus() {
            // إذا عاد التركيز للنافذة بعد فتح التطبيق
            if (wasAppOpened) {
                // ربما المستخدم عاد بسرعة، لا نفعل شيئاً
                window.removeEventListener('blur', onWindowBlur);
                window.removeEventListener('focus', onWindowFocus);
            }
        }

        // إظهار مودال التثبيت
        function showInstallModal() {
            const modal = document.getElementById('sg-install-modal');
            const content = document.getElementById('install-alert-content');
            
            content.innerHTML = `
                <i class="fas fa-download"></i>
                <h3 style="margin: 0 0 15px 0; color: #fff;">Wuffy Player غير مثبت</h3>
                <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;">
                    يبدو أن تطبيق Wuffy Player غير مثبت على جهازك. هذا التطبيق مطلوب لتشغيل الأفلام.
                </p>
                <a href="https://play.google.com/store/apps/details?id=co.wuffy.player" 
                   class="sg-install-btn" 
                   target="_blank"
                   onclick="handleInstallClick()">
                   <i class="fas fa-download" style="margin-left: 8px;"></i>
                   تحميل من متجر جوجل
                </a>
                <button class="sg-close-btn" onclick="closeInstallModal()">إلغاء</button>
            `;
            
            modal.classList.add('active');
        }

        // التعامل مع نقر زر التثبيت
        function handleInstallClick() {
            // حفظ أن المستخدم ذهب إلى المتجر
            localStorage.setItem('went_to_store', Date.now().toString());
            // يمكن إضافة تأخير قبل الإغلاق
            setTimeout(() => {
                closeInstallModal();
            }, 100);
        }

        // إغلاق مودال التثبيت
        function closeInstallModal() {
            document.getElementById('sg-install-modal').classList.remove('active');
            // إعادة التركيز على العنصر المناسب
            const card = document.getElementById(`card-${currentId}`);
            if (card) card.focus();
        }

        // وضع علامة كمشاهدة
        function markAsWatched() {
            const key = getHistoryKey();
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            
            if(!history.includes(currentId)) {
                history.push(currentId);
                localStorage.setItem(key, JSON.stringify(history));
                sgLoadState();
            }
        }

        // Image Loading with Cache Logic
        async function loadImageWithCache(url, backupUrl, movieId) {
            const cacheKey = `poster_${movieId}`;
            if (imageCache.has(cacheKey)) return imageCache.get(cacheKey);
            
            if ('caches' in window) {
                try {
                    const cache = await caches.open('arabic-movies-images');
                    const cachedResponse = await cache.match(url);
                    if (cachedResponse) {
                        const blob = await cachedResponse.blob();
                        const objectUrl = URL.createObjectURL(blob);
                        imageCache.set(cacheKey, objectUrl);
                        return objectUrl;
                    }
                } catch (error) { console.log('Cache API error:', error); }
            }
            
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    imageCache.set(cacheKey, url);
                    if ('caches' in window) {
                        caches.open('arabic-movies-images').then(cache => cache.add(url).catch(e=>console.log(e)));
                    }
                    resolve(url);
                };
                img.onerror = () => resolve(backupUrl);
                img.src = url;
            });
        }

        async function loadAndSetImage(movieId, imageUrl, backupUrl) {
            const imgElement = document.getElementById(`img-${movieId}`);
            if (!imgElement) return;
            try {
                const finalUrl = await loadImageWithCache(imageUrl, backupUrl, movieId);
                imgElement.src = finalUrl;
                imgElement.classList.add('loaded');
                imgElement.classList.remove('loading');
            } catch (error) {
                imgElement.src = backupUrl;
                imgElement.classList.add('loaded');
            }
        }

        // Search Logic
        function toggleSearch(show) {
            const header = document.getElementById('main-header');
            const title = document.getElementById('header-title');
            const leftActions = document.getElementById('normal-header-left');
            const rightActions = document.getElementById('normal-header-right');
            const searchContainer = document.getElementById('search-input-container');
            const searchInput = document.getElementById('search-input');

            if(show) {
                isSearchActive = true;
                header.classList.add('header-search-active');
                title.style.display = 'none';
                leftActions.style.display = 'none';
                rightActions.style.display = 'none';
                searchContainer.style.display = 'flex';
                setTimeout(() => searchInput.focus(), 100);
            } else {
                isSearchActive = false;
                header.classList.remove('header-search-active');
                title.style.display = 'block';
                leftActions.style.display = 'flex';
                rightActions.style.display = 'flex';
                searchContainer.style.display = 'none';
                clearSearch();
            }
        }

        function clearSearch() {
            document.getElementById('search-input').value = "";
            renderGrid(movies);
            if (isSearchActive) setTimeout(() => document.getElementById('search-input').focus(), 50);
        }

        function handleSearch(query) {
            const lowerQuery = query.toLowerCase();
            const filtered = movies.filter(movie => 
                movie.title.toLowerCase().includes(lowerQuery) || 
                movie.year.includes(lowerQuery) ||
                movie.id.toLowerCase().includes(lowerQuery)
            );
            renderGrid(filtered);
        }

        // Grid Rendering for Movies
        async function renderGrid(data = movies) {
            const grid = document.getElementById('sg-grid-root');
            if(data.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-film"></i>
                        <p>عذراً، لم نجد أفلام بهذا الاسم!</p>
                        <button class="reset-search-btn" onclick="toggleSearch(false)" tabindex="110">العودة للقائمة</button>
                    </div>`;
                return;
            }

            grid.innerHTML = data.map((movie, i) => `
                <div class="sg-card-item" 
                     tabindex="${i+10}" 
                     id="card-${movie.id}" 
                     onclick="sgOpenMenu('${movie.id}')"
                     onkeydown="handleCardKeydown(event, '${movie.id}')">
                    <div class="sg-watched-badge"><i class="fas fa-eye"></i></div>
                    <div class="sg-poster-box">
                        <img id="img-${movie.id}" 
                             src="${movie.backupPoster}" 
                             class="loading" 
                             alt="${movie.title}"
                             onerror="this.src='${movie.backupPoster}'; this.classList.add('loaded');">
                    </div>
                    <div class="sg-card-meta">
                        <div class="sg-episode-label">${movie.title}</div>
                        <div class="movie-year">${movie.year}</div>
                    </div>
                </div>
            `).join('');
            
            sgLoadState();
            
            // Lazy load images
            data.forEach(movie => {
                setTimeout(() => loadAndSetImage(movie.id, movie.poster, movie.backupPoster), 50);
            });
        }

        // Menu Logic
        function sgOpenMenu(id) {
            currentId = id;
            const movie = movies.find(m => m.id === id);
            const container = document.getElementById('sg-servers-container');
            const modalTitle = document.getElementById('sg-modal-title');
            
            if(!movie) return;

            modalTitle.textContent = `${movie.title} (${movie.year})`;

            // Generate quality buttons
            container.innerHTML = movie.links.map((link, index) => {
                let label = link.quality === "FHD" ? 'FHD 1080p' : (link.quality === "HD" ? 'HD 720p' : 'SD 480p');
                let qClass = link.quality === "FHD" ? 'q-fhd' : (link.quality === "HD" ? 'q-hd' : 'q-sd');
                let serverName = link.quality === "FHD" ? 'جودة عالية' : (link.quality === "HD" ? 'جودة متوسطة' : 'جودة منخفضة');
                
                return `
                <button class="sg-server-btn" 
                        tabindex="${20 + index}" 
                        onclick="sgPlay('${link.url}')"
                        onkeydown="handleModalKeydown(event, '${link.url}')">
                    <span><i class="fas fa-play" style="margin-left:8px; font-size:0.8rem;"></i> ${serverName}</span>
                    <span class="sg-quality ${qClass}">${label}</span>
                </button>
                `;
            }).join('');

            const modal = document.getElementById('sg-main-modal');
            modal.classList.add('active');
            
            // Focus first server button
            setTimeout(() => {
                const firstBtn = container.querySelector('button');
                if(firstBtn) firstBtn.focus();
            }, 100);
        }

        function sgCloseMenu() {
            document.getElementById('sg-main-modal').classList.remove('active');
            // Return focus to the card
            const card = document.getElementById(`card-${currentId}`);
            if(card) card.focus();
        }

        // الدالة المحسنة لتشغيل الفيديو
        function sgPlay(url) {
            // إغلاق القائمة أولاً
            sgCloseMenu();
            
            // التحقق من وجود التطبيق
            checkWuffyPlayerInstalled(url);
        }

        // History Management
        function sgLoadState() {
            const key = getHistoryKey();
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            document.querySelectorAll('.sg-card-item').forEach(card => {
                const id = card.id.split('-')[1];
                if(history.includes(id)) {
                    card.classList.add('is-watched');
                } else {
                    card.classList.remove('is-watched');
                }
            });
        }

        function confirmReset() {
            const key = getHistoryKey();
            if(confirm('هل أنت متأكد من مسح سجل مشاهدة الأفلام؟')) {
                localStorage.removeItem(key);
                sgLoadState();
            }
        }

        // Navigation / Keyboard Accessibility
        function handleCardKeydown(event, id) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sgOpenMenu(id);
            }
            handleGridNavigation(event);
        }

        function handleModalKeydown(event, link) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sgPlay(link);
            }
            if (event.key === 'Escape' || event.key === 'Backspace') {
                event.preventDefault();
                sgCloseMenu();
            }
        }

        function handleGridNavigation(event) {
            const cards = Array.from(document.querySelectorAll('.sg-card-item'));
            const current = document.activeElement;
            const index = cards.indexOf(current);
            if(index === -1) return;

            let nextIndex = index;
            const columns = getComputedStyle(document.getElementById('sg-grid-root')).gridTemplateColumns.split(' ').length;

            switch(event.key) {
                case 'ArrowRight': nextIndex = index - 1; break; // RTL
                case 'ArrowLeft': nextIndex = index + 1; break;  // RTL
                case 'ArrowUp': nextIndex = index - columns; break;
                case 'ArrowDown': nextIndex = index + columns; break;
            }

            // Improved navigation to escape grid upwards to controls
            if (event.key === 'ArrowUp' && nextIndex < 0) {
                 event.preventDefault();
                 document.querySelector('.section-header button').focus();
                 return;
            }

            if(nextIndex >= 0 && nextIndex < cards.length) {
                event.preventDefault();
                cards[nextIndex].focus();
                cards[nextIndex].scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // التحقق من العودة من المتجر
        window.addEventListener('focus', function() {
            const storeTime = localStorage.getItem('went_to_store');
            if (storeTime) {
                const timeDiff = Date.now() - parseInt(storeTime);
                // إذا عدنا من المتجر خلال 10 ثوان
                if (timeDiff < 10000) {
                    // حاول فتح الرابط مرة أخرى
                    if (currentUrl) {
                        setTimeout(() => {
                            window.location.href = currentUrl;
                        }, 500);
                    }
                }
                localStorage.removeItem('went_to_store');
            }
        });

        // تنظيف الـ listeners عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            window.removeEventListener('blur', onWindowBlur);
            window.removeEventListener('focus', onWindowFocus);
            clearTimeout(appCheckTimeout);
        });

        // Initialize
        window.onload = function() {
            renderGrid();
            // Focus first card on load
            setTimeout(() => {
                const firstCard = document.querySelector('.sg-card-item');
                if(firstCard) firstCard.focus();
            }, 500);
        };

    </script>
</body>
</html>